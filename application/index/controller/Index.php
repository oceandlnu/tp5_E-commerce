<?php

namespace app\index\controller;

use think\Controller;
use think\Request;
use think\Db;
use think\Session;
use think\Cookie;
use app\admin\model\User;
use app\admin\model\Cate;
use app\admin\model\Pro;
use app\admin\model\Album;
use app\admin\model\ShopCar;
use app\admin\model\Address;
use app\admin\model\Order;

class Index extends Controller
{
    public function _initialize()
    {
        parent::_initialize(); // TODO: Change the autogenerated stub
    }

    public function check()
    {
        if (User::check_is_login()) {
            $res = 'index';
        } elseif (!Request::instance()->has('verify', 'post')) {
            $res = 'login';
        } else {
            $data = Request::instance()->post();
            if (User::check_login($data)) {
                $res = 'index';
            } else {
                $res = 'login';
            }
        }
        $this->success('', $res, '', 1);
    }

    public function index()
    {
//        $this->view->engine->layout(true);
        $cates = Cate::all();
        $this->assign('cates', $cates);
        $this->assign('title', '首页');
        return $this->fetch();
    }

    public function login()
    {
        $cates = Cate::all();
        $this->assign('cates', $cates);
        $this->assign('title', '用户登录');
        return $this->fetch();
    }

    public function logout()
    {
        User::logout();
        $this->success('', 'index', '', 1);
    }

    public function reg()
    {
        $cates = Cate::all();
        $this->assign('cates', $cates);
        $this->assign('title', '注册');
        return $this->fetch();
    }

    public function doReg()
    {
        $request = Request::instance();
        $data = $request->post();
        if ($data['password'] !== $data['confirmPwd']) {
            alertMes("两次输入密码不一致，请重新输入");
            $this->success('', 'reg');
        }
        $facePath = "public/static/index/images/userFaces";
        $file = $request->file('face');
        if ($file) {
            $vali = ['ext' => 'jpg,png,gif'];
            $rule = 'uniqid';
            $info = $file->rule($rule)->validate($vali)->move(ROOT_PATH . $facePath);
            if ($info) {
                $data['face'] = $info->getSaveName();
            } else {
                echo $info->getError();
            }
            $data['regTime'] = time();
            $data['password'] = md5($data['password']);
            $user = new User($data);
            $user->allowField(true)->save();
            $id = $user->id;
            alertMes("注册成功");
            Cookie::set('userId', $id, 7 * 24 * 3600);
            Cookie::set('userName', $data['username'], 7 * 24 * 3600);
            Session::set('userId', $id);
            Session::set('userName', $data['username']);
            $this->success('', 'index');
        } else {
            alertMes("请上传头像");
            $this->success('', 'reg');
        }
    }

    public function proCate()
    {
//        $this->view->engine->layout(true);
        $request = Request::instance();
        $id = $request->get('id');
        $cates = Cate::all();
        if ($id == "all") {
            $cateNum = $cates;
            $id = 0;
            $this->assign('title', '全部商品');
        } else {
            $cateNum = Cate::all(["id" => $id]);
            foreach ($cateNum as $cate) {
                $this->assign('title', $cate['cName']);
            }
        }
        $this->assign('cates', $cates);
        $this->assign('cateNum', $cateNum);
        $this->assign('id', $id);
        return $this->fetch();
    }

    public function proDetailsOld()
    {
        $request = Request::instance();
        $id = $request->get('id');
        $str = "p.id,p.pName,p.pSn,p.pNum,p.mPrice,p.iPrice,p.pDesc,p.pubTime,p.isShow,p.isHot,c.cName,p.cId";
        $proInfo = Pro::alias('p')->field($str)->join('shop_cate c', 'p.cId=c.id')->where(['p.id' => $id])->find();
        $proImgs = Album::where(['pid' => $id])->column('albumPath');
        $this->assign('proInfo', $proInfo);
        $this->assign('proImgs', $proImgs);
        $this->assign('id', $id);
//        dump($proImgs);
        return $this->fetch();
    }

    public function proDetails()
    {
        $request = Request::instance();
        $id = $request->get('id');
        $str = "p.id,p.pName,p.pSn,p.pNum,p.mPrice,p.iPrice,p.pDesc,p.pubTime,p.isShow,p.isHot,c.cName,p.cId";
        $proInfo = Pro::alias('p')->field($str)->join('shop_cate c', 'p.cId=c.id')->where(['p.id' => $id])->find();
        $proImgs = Album::where(['pid' => $id])->column('albumPath');
        $cates = Cate::all();
        $this->assign('cates', $cates);
        $this->assign('proInfo', $proInfo);
        $this->assign('proImgs', $proImgs);
        $this->assign('id', $id);
        $this->assign('title', $proInfo['pName']);
        return $this->fetch();
    }

    public function shopCar()
    {
        $cates = Cate::all();
        $request = Request::instance();
        $uid = $request->get("uid");
        $rows = ShopCar::all(["uid" => $uid]);
        $this->assign('cates', $cates);
        $this->assign('rows', $rows);
        $this->assign('title', '我的购物车');
        return $this->fetch();
    }

    public function shopCarOld()
    {
        $cates = Cate::all();
        $this->assign('cates', $cates);
        $this->assign('title', '我的购物车');
        return $this->fetch();
    }

    public function addShopCar()
    {
        $request = Request::instance();
        $data = $request->post();
        $shopCar = new ShopCar($data);
        if ($shopCar->allowField(true)->save()) {
            echo "添加成功";
        } else {
            echo "添加失败";
        }
    }

    public function delShopCar()
    {
        $request = Request::instance();
        $data = $request->post();
        $id = explode(",", $data['id']);
        $res = ShopCar::destroy($id);
        if ($res) {
            echo "删除成功";
        } else {
            echo "删除失败";
        }
    }

    public function settlement()
    {
        $cates = Cate::all();
        $request = Request::instance();
        $data = $request->get();
        $id = explode(",", $data['id']);
        $rows=ShopCar::all($id);
        $adds = Address::all(["uId" => $data['uId']]);
        if ($adds == null){
            alertMes("请添加收货地址");
            echo "<script>location.href='addAddress?uId=".$data['uId']."';</script>";
//            $this->success('', 'addAddress?uId='.$data['uId']);
        }
        $this->assign('rows', $rows);
        $this->assign('adds', $adds);
        $this->assign('cates', $cates);
        $this->assign('title', '清单结算');
        return $this->fetch();
    }

    public function address(){
        $request = Request::instance();
        $dataPost = $request->post();
        if ($dataPost['action'] == "add"){
            $address = new Address($dataPost);
            if ($address->allowField(true)->save()) {
                echo "添加成功";
            } else {
                echo "添加失败";
            }
        }elseif ($dataPost['action'] == "del"){
            if (Address::destroy(['id'=>$dataPost['id']])) {
                echo "删除成功";
            } else {
                echo "删除失败";
            }
        }
    }

    public function addAddress(){
        $cates = Cate::all();
        $request = Request::instance();
        $data = $request->get();
        $this->assign('uId', $data['uId']);
        $this->assign('cates', $cates);
        $this->assign('title', '添加收货地址');
        return $this->fetch();
    }

    public function modAddress(){
        $cates = Cate::all();
        $request = Request::instance();
        $data = $request->get();
        $row = Address::get($data['id']);
        $this->assign('row', $row);
        $this->assign('uId', $data['uId']);
        $this->assign('cates', $cates);
        $this->assign('title', '修改收货地址');
        return $this->fetch();
    }

    public function doModAddress(){
        $request = Request::instance();
        $data = $request->post();
        $id = $data['id'];
        $address = new Address();
        if ($address->allowField(true)->save($data, ['id' => $id])){
            echo "修改成功";
        }else{
            echo "修改失败";
        }
    }

    public function order(){
        $request = Request::instance();
        $dataPost = $request->post();
        if ($dataPost['action'] == "add"){
            $dataPost['oNum']=time();
            $order = new Order($dataPost);
            if ($order->allowField(true)->save()) {
                echo "提交成功";
            } else {
                echo "提交失败";
            }
        }elseif ($dataPost['action'] == "del"){
            if (Order::destroy(['id'=>$dataPost['id']])) {
                echo "操作成功";
            } else {
                echo "操作失败";
            }
        }
    }

    public function search()
    {
        $request = Request::instance();
        $keywords = $request->get('keywords');
        $cates = Cate::all();
        $pros = Pro::where("pName like '%{$keywords}%'")->select();
        $this->assign('proName', $keywords);
        $this->assign('cates', $cates);
        $this->assign('pros', $pros);
        $this->assign('title', $keywords . '_搜索结果');
        return $this->fetch();
    }

    public function _empty()
    {
        return '404';
    }
}
